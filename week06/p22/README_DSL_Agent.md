# 咖啡机 DSL Agent 系统

## 项目概述

本项目实现了一个智能咖啡机 DSL Agent 系统，能够根据用户的自然语言输入自动生成和执行咖啡制作指令。

## 核心功能

### 1. DSL 模板系统
- **模板文件**: `coffee.dsl.tpl` - 包含参数占位符的 DSL 模板
- **参数支持**: 温度、加热时间、萃取强度等可配置参数
- **模板渲染**: 使用 Jinja2 引擎进行参数替换

### 2. 自然语言解析
- **智能提取**: 从用户输入中提取温度、时间、萃取强度等参数
- **多种表达**: 支持"90度"、"90°C"、"温度90"等多种表达方式
- **默认值**: 为未指定的参数提供合理的默认值

### 3. DSL 验证系统
- **语法验证**: 使用 Lark 解析器验证 DSL 语法正确性
- **逻辑验证**: 检查节点和边的完整性和一致性
- **错误报告**: 提供详细的验证错误信息

### 4. 执行引擎
- **模拟执行**: 模拟咖啡制作的完整流程
- **状态跟踪**: 实时显示执行状态和进度
- **结果反馈**: 提供详细的执行日志和参数总结

## 文件结构

```
├── coffee.dsl.tpl              # DSL 模板文件
├── coffee_agent.py             # Agent 系统主文件
├── coffee_dsl.lark            # DSL 语法定义（已扩展）
├── lark_parser.py             # DSL 解析器
├── demo.py                    # 演示脚本
├── coffee_rules_generated.dsl # 生成的 DSL 文件
└── README_DSL_Agent.md        # 项目说明文档
```

## 使用方法

### 1. 基本使用

```python
from coffee_agent import CoffeeDSLAgent

# 创建 Agent 实例
agent = CoffeeDSLAgent()

# 处理用户请求
result = agent.process_user_request("帮我做一杯90度加热20秒的轻度萃取")

if result["success"]:
    print("咖啡制作完成！")
    print(f"参数: {result['parameters']}")
```

### 2. 命令行演示

```bash
# 运行基本演示
python demo.py

# 运行交互模式
python demo.py interactive
```

### 3. 单独测试

```bash
# 测试 Agent 系统
python coffee_agent.py
```

## 支持的用户输入格式

### 温度设置
- "90度" / "90°C" / "温度90"
- 默认值: 90°C

### 加热时间
- "加热20秒" / "20秒"
- 默认值: 20秒

### 萃取强度
- "轻度萃取" → light
- "中度萃取" → medium  
- "重度萃取" → strong
- 默认值: medium

### 示例输入
- "帮我做一杯90度加热20秒的轻度萃取"
- "我要一杯95度的重度萃取咖啡，加热30秒"
- "制作一杯85度中度萃取15秒的咖啡"
- "来一杯普通咖啡" (使用默认参数)

## 系统架构

### 1. 模板加载器
- 读取 DSL 模板文件
- 验证模板格式和语法

### 2. 参数解析器
- 使用正则表达式提取用户输入中的参数
- 支持多种自然语言表达方式
- 提供智能默认值

### 3. 模板渲染器
- 使用 Jinja2 引擎进行参数替换
- 生成完整的可执行 DSL 代码

### 4. DSL 验证器
- 语法验证: 使用 Lark 解析器
- 逻辑验证: 检查节点和边的完整性
- 错误处理: 提供详细的错误信息

### 5. 执行引擎
- 解析生成的 DSL 代码
- 模拟咖啡制作流程
- 提供实时状态反馈

## 技术特性

### 1. 扩展性
- 模块化设计，易于扩展新功能
- 支持自定义 DSL 语法规则
- 可配置的参数映射

### 2. 健壮性
- 完整的错误处理机制
- 输入验证和默认值处理
- 详细的日志和调试信息

### 3. 用户友好
- 自然语言输入支持
- 直观的执行反馈
- 交互式演示模式

## 依赖项

```
lark-parser>=1.1.0
jinja2>=3.1.0
```

## 安装和运行

```bash
# 安装依赖
pip install lark-parser jinja2

# 运行演示
python demo.py

# 交互模式
python demo.py interactive
```

## 扩展说明

### 1. 添加新参数
1. 在 `coffee.dsl.tpl` 中添加新的占位符
2. 在 `coffee_agent.py` 的 `parse_user_input` 方法中添加解析逻辑
3. 更新默认值设置

### 2. 扩展 DSL 语法
1. 修改 `coffee_dsl.lark` 文件添加新的语法规则
2. 更新 `lark_parser.py` 中的转换器
3. 在验证器中添加相应的逻辑检查

### 3. 自定义执行逻辑
1. 修改 `execute_coffee_making` 方法
2. 添加新的执行步骤和状态跟踪
3. 扩展结果反馈格式

## 示例输出

```
🎯 处理用户请求: 帮我做一杯90度加热20秒的轻度萃取
==================================================
✓ 成功加载模板文件: coffee.dsl.tpl
✓ 解析用户输入参数: {'TEMPERATURE': 90, 'TEMPERATURE_CHECK': 89, 'HEATING_TIME': 20, 'EXTRACTION_STRENGTH': 'light'}
✓ 模板渲染成功
✓ DSL 验证通过
✓ 渲染后的 DSL 已保存到: coffee_rules_generated.dsl
==================================================
🎉 处理完成!

📊 执行结果:
  🚀 开始执行咖啡制作流程...
  📊 检查水位...
  🔥 开始加热到 90°C...
  🌡️ 水温已达到 90°C
  ⚙️ 设置萃取强度为 "light"
  ☕ 开始制作咖啡，萃取时间 20 秒...
  ✅ 咖啡制作完成！
  📋 参数总结: 温度90°C，萃取20秒，"light"萃取
```